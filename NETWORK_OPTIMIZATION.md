# 网络连接优化说明

## 🔧 已实施的优化

### 1. 客户端请求优化

**省份城市选择组件** (`components/province-city-select.tsx`):
- ✅ 添加了请求超时控制（15秒）
- ✅ 添加了重试机制（最多2次）
- ✅ 添加了清理函数，防止内存泄漏
- ✅ 减少了错误日志输出（只在非超时错误时打印）

### 2. API 路由优化

**省份和城市 API** (`app/api/provinces/route.ts`, `app/api/cities/route.ts`):
- ✅ 网络超时时返回空数组，而不是错误
- ✅ 优雅降级，不影响页面显示

### 3. 服务端查询优化

**位置查询** (`server/queries/locations.ts`):
- ✅ 减少了超时错误的日志输出
- ✅ 返回空数组而不是抛出错误

## 📊 错误处理策略

### 超时错误处理
- **客户端**: 自动重试2次，每次间隔2秒
- **服务端**: 返回空数组，优雅降级
- **日志**: 只在非超时错误时打印详细日志

### 用户体验
- 即使网络超时，页面也能正常显示
- 省份和城市选择器会显示为空（而不是崩溃）
- 用户可以继续使用其他功能

## ⚠️ 如果仍然频繁出现超时

### 可能的原因
1. **网络环境问题**
   - 防火墙阻止了 HTTPS 连接
   - VPN/代理配置问题
   - DNS 解析问题

2. **Supabase 服务问题**
   - 检查 Supabase Status: https://status.supabase.com/
   - 检查项目是否正常运行

3. **环境变量配置**
   - 确认 `NEXT_PUBLIC_SUPABASE_URL` 正确
   - 确认 `SUPABASE_SERVICE_ROLE_KEY` 正确

### 建议的解决方案

1. **检查网络连接**
   ```bash
   # 测试能否访问 Supabase
   curl -v https://your-project.supabase.co/rest/v1/
   ```

2. **检查环境变量**
   ```bash
   # 确认环境变量已设置
   echo $NEXT_PUBLIC_SUPABASE_URL
   ```

3. **使用代理（如果需要）**
   - 配置 Node.js 使用代理
   - 或在 Supabase Dashboard 检查 IP 白名单

4. **临时解决方案**
   - 如果网络问题持续，可以考虑：
     - 使用本地缓存的基础数据
     - 增加超时时间
     - 使用 CDN 加速

## 📝 当前配置

- **超时时间**: 15秒
- **重试次数**: 2次
- **重试间隔**: 2秒
- **错误日志**: 只在非超时错误时输出

## 🔄 后续优化建议

如果网络问题持续存在，可以考虑：
1. 实现客户端缓存（localStorage）
2. 使用 Service Worker 缓存 API 响应
3. 预加载基础数据（省份、城市）
4. 使用静态数据作为后备方案

